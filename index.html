<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilingual Quiz & Puzzle Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #1D2142;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .page {
            display: none;
            width: 100%;
            min-height: 100vh;
            padding: 20px;
        }

        .page.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Intro Page Styles */
        .logo-container {
            margin-bottom: 30px;
            text-align: center;
        }

        .logo-placeholder {
            width: 120px;
            height: 80px;
            border: 2px dashed #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border-radius: 8px;
        }

        .game-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 40px;
            text-align: center;
        }

        .arabic-title {
            font-size: 56px;
            margin-bottom: 10px;
        }

        .input-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .input-label {
            font-size: 18px;
            margin-bottom: 15px;
            display: block;
        }

        .code-input {
            width: 300px;
            height: 50px;
            font-size: 24px;
            text-align: center;
            border: none;
            border-radius: 8px;
            background-color: white;
            color: #1D2142;
            margin-bottom: 20px;
        }

        .continue-btn {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .continue-btn:hover {
            transform: scale(1.05);
        }

        .notes {
            text-align: center;
            margin-top: 30px;
        }

        .good-luck {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2ecc71;
        }

        .timing-note {
            font-size: 16px;
            max-width: 600px;
            line-height: 1.4;
        }

        /* Game Page Styles */
        .game-container {
            display: flex;
            width: 100%;
            max-width: 1400px;
            gap: 20px;
        }

        .sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .current-player {
            background: linear-gradient(135deg, #3498db, #2980b9);
            margin-bottom: 20px;
        }

        .other-players .player-avatar {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .player-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 14px;
            margin-top: 5px;
        }

        .challenges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .challenge-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: transform 0.2s, background-color 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .challenge-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.15);
        }

        .challenge-card.completed {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }

        .challenge-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #3498db;
        }

        .challenge-question {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .option {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .option:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .option.selected {
            background: #3498db;
        }

        .math-input {
            width: 100px;
            height: 40px;
            font-size: 18px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin: 0 10px;
        }

        .maze-container {
            display: grid;
            grid-template-columns: repeat(5, 40px);
            grid-template-rows: repeat(5, 40px);
            gap: 2px;
            justify-content: center;
            margin: 20px 0;
        }

        .maze-cell {
            width: 40px;
            height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .maze-cell.wall {
            background: #34495e;
            cursor: not-allowed;
        }

        .maze-cell.path {
            background: rgba(255, 255, 255, 0.1);
        }

        .maze-cell.start {
            background: #2ecc71;
        }

        .maze-cell.end {
            background: #e74c3c;
        }

        .maze-cell.selected {
            background: #f39c12;
        }

        .submit-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
        }

        .finish-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            align-self: center;
        }

        /* Results Page Styles */
        .results-container {
            width: 100%;
            max-width: 1000px;
            text-align: center;
        }

        .results-title {
            font-size: 36px;
            margin-bottom: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .result-card.winner {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: #1D2142;
        }

        .result-card.current-player {
            border: 3px solid #3498db;
        }

        .result-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .result-info {
            flex: 1;
            text-align: right;
        }

        .result-name {
            font-size: 18px;
            font-weight: bold;
        }

        .result-stats {
            font-size: 14px;
            margin-top: 5px;
        }

        .final-note {
            font-size: 16px;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .timer-expired {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                display: flex;
                gap: 10px;
                overflow-x: auto;
                padding: 15px;
            }
            
            .player-avatar {
                flex-shrink: 0;
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Intro Page -->
    <div class="page active" id="introPage">
        <div class="logo-container">
            <!-- NOTE: Add your SVG logo here, replace the placeholder div -->
            <div class="logo-placeholder">LOGO HERE</div>
        </div>
        
        <h1 class="game-title">
            <div class="arabic-title">اسم اللعبة</div>
            <div>Game Name</div>
        </h1>
        
        <div class="input-section">
            <label class="input-label">
                أدخل الكود الخاص بك / Enter Your Code
            </label>
            <input type="text" class="code-input" id="playerCode" maxlength="4" placeholder="0000">
            <br>
            <button class="continue-btn" onclick="startGame()">
                المتابعة / continue
            </button>
        </div>
        
        <div class="notes">
            <div class="good-luck">حظاً موفقاً / GOOD LUCK!</div>
            <div class="timing-note">
                التوقيت مهم! تأكد من أن تنتهي بأسرع وقت ممكن!<br>
                Timing is Important! Make sure to finish as fast as possible!
            </div>
        </div>
    </div>

    <!-- Game Page -->
    <div class="page" id="gamePage">
        <div class="game-container">
            <div class="sidebar">
                <div class="current-player">
                    <div class="player-avatar" id="currentPlayerAvatar">😊</div>
                </div>
                <div class="other-players" id="otherPlayers">
                    <!-- Other player avatars will be populated here -->
                </div>
            </div>
            
            <div class="game-area">
                <div class="player-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="playerTime">00:00</div>
                        <div class="stat-label">الوقت / Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="playerPoints">0/20</div>
                        <div class="stat-label">النقاط / Points</div>
                    </div>
                </div>
                
                <div class="challenges-grid" id="challengesGrid">
                    <!-- Challenges will be populated here -->
                </div>
                
                <button class="finish-btn" onclick="finishGame()" id="finishBtn" style="display: none;">
                    إنهاء اللعبة / Finish Game
                </button>
            </div>
        </div>
    </div>

    <!-- Results Page -->
    <div class="page" id="resultsPage">
        <div class="results-container">
            <h2 class="results-title">
                لائحة النتائج<br>
                List of Results
            </h2>
            
            <div class="results-grid" id="resultsGrid">
                <!-- Results will be populated here -->
            </div>
            
            <div class="final-note" id="finalNote">
                هذه هي النتائج الحالية (قد تتغير مع انتهاء بقية اللاعبين)<br>
                 These are the current results (they may change as more players finish).
            </div>
        </div>
    </div>

    <script>

/* ----------------- Config ----------------- */
const GAME_CONFIG = {
    gameDurationHours: 24
};

// <-- REPLACE this with your DEPLOYED Apps Script /exec URL -->
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxTnl0GuX1vzmQRPfOfhLoZktLMHIpT-aCRDJx-lmmeP1Vd_XuQViEyQ_bTK-lN2GlP/exec";

/* -------------- Helper: HTTP to Sheet -------------- */
// Save result to Google Sheet (doPost)
async function saveResult(playerCode, playerData) {
    await fetch(SHEET_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            Code: playerCode,
            Name: playerData.name,
            Avatar: playerData.avatar,
            Points: playerData.points,
            Time: playerData.time
        })
    });
}

// Load all rows from Google Sheet (doGet) and normalize fields
async function loadResultsArray() {
    const res = await fetch(SHEET_URL);
    const rows = await res.json();

    // Normalize field names and types for internal usage
    const normalized = rows.map(r => ({
        Code: String(r.Code ?? r.code ?? "").trim(),
        Name: r.Name ?? r.name ?? "Player",
        Avatar: r.Avatar ?? r.avatar ?? "🙂",
        Points: parseInt(r.Points ?? r.points ?? 0, 10) || 0,
        Time: parseInt(r.Time ?? r.time ?? 0, 10) || 0,
        // keep other fields if exist (e.g., Location)
        ...r
    }));

    // Sort: highest points first, then fastest time
    normalized.sort((a, b) => {
        if (b.Points !== a.Points) return b.Points - a.Points;
        return a.Time - b.Time;
    });

    return normalized;
}

/* ----------------- Game state ----------------- */
let gameState = {
    currentPlayer: null, // { code, name, avatar }
    startTime: null,
    endTime: null,
    currentPoints: 0,
    completedChallenges: new Set(),
    gameStarted: Date.now(),
    gameExpired: false
};

/* -------------- Static challenges (unchanged) -------------- */
const challenges = [
    { id: 'quiz1', type: 'quiz', title: 'التحدي الأول / 1st Challenge', question: 'ما هي عاصمة المملكة العربية السعودية؟ / What is the capital of Saudi Arabia?', options:['الرياض / Riyadh','جدة / Jeddah','مكة / Makkah','القصيم / Alkaseem'], correct:0, points:5 },
    { id: 'quiz2', type: 'quiz', title: 'التحدي الثاني / 2nd Challenge', question: 'كم عدد أيام السنة؟ / How many days are in a year?', options:['364','365','366','367'], correct:1, points:5 },
    { id: 'math1', type: 'math', title: 'التحدي الثالث / 3rd Challenge', question: '15 + 27 = ?', answer:42, points:3 },
    { id: 'math2', type: 'math', title: 'التحدي الرابع / 4th Challenge', question: '8 × 7 = ?', answer:56, points:3 }
];

/* -------------- UI / Game functions -------------- */
function checkGameExpiry() {
    const now = Date.now();
    const gameEnd = gameState.gameStarted + (GAME_CONFIG.gameDurationHours * 60 * 60 * 1000);
    gameState.gameExpired = now > gameEnd;
}

function initGame() {
    checkGameExpiry();
    populateOtherPlayers();
    renderChallenges();
    if (!gameState.gameExpired) startTimer();
}

async function startGame() {
    const code = document.getElementById('playerCode').value.trim();
    if (!code || code.length !== 4) {
        alert('يرجى إدخال كود صحيح من 4 أرقام / Please enter a valid 4-digit code');
        return;
    }

    // Fetch players/rows from sheet
    let rows;
    try {
        rows = await loadResultsArray();
    } catch (e) {
        console.error("Failed to load sheet rows:", e);
        alert('خطأ في الاتصال بالخادم. تأكد من أن رابط Google Apps Script صحيح وأنه تم نشره كـ Web App.');
        return;
    }

    const playerRow = rows.find(r => String(r.Code) === code);
    if (!playerRow) {
        alert('كود غير صحيح / Invalid code');
        return;
    }

    // If this code already has Points & Time -> show results immediately
    if (playerRow.Points && playerRow.Time) {
        // set current player for highlighting in results
        gameState.currentPlayer = { code, name: playerRow.Name, avatar: playerRow.Avatar };
        showResults();
        return;
    }

    // Start the game for this player
    gameState.currentPlayer = { code, name: playerRow.Name, avatar: playerRow.Avatar };
    gameState.startTime = Date.now();
    gameState.currentPoints = 0;
    gameState.completedChallenges = new Set();

    document.getElementById('introPage').classList.remove('active');
    document.getElementById('gamePage').classList.add('active');

    initGame();
}

function populateOtherPlayers() {
    const container = document.getElementById('otherPlayers');
    container.innerHTML = '';
    document.getElementById('currentPlayerAvatar').textContent = (gameState.currentPlayer && gameState.currentPlayer.avatar) ? gameState.currentPlayer.avatar : '🙂';
    // We removed the old GAME_CONFIG.players loop because players list is in the sheet now
}

function renderChallenges() {
    const container = document.getElementById('challengesGrid');
    container.innerHTML = '';
    challenges.forEach(challenge => container.appendChild(createChallengeCard(challenge)));
}

function createChallengeCard(challenge) {
    const card = document.createElement('div');
    card.className = 'challenge-card';
    card.dataset.challengeId = challenge.id;

    let content = `<div class="challenge-title">${challenge.title}</div><div class="challenge-question">${challenge.question}</div>`;
    if (challenge.type === 'quiz') {
        content += '<div class="options">';
        challenge.options.forEach((option, index) => content += `<button class="option" onclick="selectOption('${challenge.id}', ${index})">${String.fromCharCode(65 + index)}. ${option}</button>`);
        content += '</div>';
    } else if (challenge.type === 'math') {
        content += `<input type="number" class="math-input" id="math-${challenge.id}" placeholder="?">`;
    }

    content += `<button class="submit-btn" onclick="submitChallenge('${challenge.id}')">إرسال / Submit</button>`;
    card.innerHTML = content;
    return card;
}

function selectOption(challengeId, optionIndex) {
    const card = document.querySelector(`[data-challenge-id="${challengeId}"]`);
    const options = card.querySelectorAll('.option');
    options.forEach(opt => opt.classList.remove('selected'));
    options[optionIndex].classList.add('selected');
    const challenge = challenges.find(c => c.id === challengeId);
    challenge.selectedOption = optionIndex;
}

function submitChallenge(challengeId) {
    const challenge = challenges.find(c => c.id === challengeId);
    const card = document.querySelector(`[data-challenge-id="${challengeId}"]`);
    let correct = false;
    if (challenge.type === 'quiz') {
        correct = challenge.selectedOption === challenge.correct;
    } else if (challenge.type === 'math') {
        const input = document.getElementById(`math-${challengeId}`);
        correct = parseInt(input.value, 10) === challenge.answer;
    }
    if (correct) {
        gameState.currentPoints += challenge.points;
        gameState.completedChallenges.add(challengeId);
        card.classList.add('completed');
        const buttons = card.querySelectorAll('button, input');
        buttons.forEach(b => b.disabled = true);
        updatePlayerStats();
        if (gameState.completedChallenges.size === challenges.length) document.getElementById('finishBtn').style.display = 'block';
        alert('إجابة صحيحة! / Correct answer!');
    } else {
        alert('إجابة خاطئة، حاول مرة أخرى / Wrong answer, try again');
    }
}

function updatePlayerStats() {
    document.getElementById('playerPoints').textContent = `${gameState.currentPoints}/${challenges.reduce((s,c)=>s+c.points,0)}`;
}

function startTimer() {
    setInterval(() => {
        if (gameState.startTime) {
            const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('playerTime').textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
        }
    }, 1000);
}

async function finishGame() {
    gameState.endTime = Date.now();
    const totalTime = Math.floor((gameState.endTime - gameState.startTime) / 1000);

    // Use current player's code
    const playerCode = gameState.currentPlayer && gameState.currentPlayer.code;
    if (!playerCode) {
        alert('خطأ: رمز اللاعب غير موجود');
        return;
    }

    // Save to sheet then show results
    try {
        await saveResult(playerCode, {
            name: gameState.currentPlayer.name,
            avatar: gameState.currentPlayer.avatar,
            points: gameState.currentPoints,
            time: totalTime
        });
    } catch (e) {
        console.error("Save failed:", e);
        alert('حصل خطأ أثناء حفظ النتيجة. حاول مرة أخرى.');
        return;
    }

    showResults();
}

async function showResults() {
    document.getElementById('introPage').classList.remove('active');
    document.getElementById('gamePage').classList.remove('active');
    document.getElementById('resultsPage').classList.add('active');

    // Load rows and render list
    const rows = await loadResultsArray();
    renderResultsList(rows);
}

/* Rendered cards — tolerant to Sheet columns */
function createResultCard(normalizedRow, isWinner, isCurrentPlayer) {
    const name = normalizedRow.Name;
    const avatar = normalizedRow.Avatar;
    const points = normalizedRow.Points;
    const time = normalizedRow.Time;

    const card = document.createElement('div');
    card.className = 'result-card';
    if (isWinner) card.classList.add('winner');
    if (isCurrentPlayer) card.classList.add('current-player');

    card.innerHTML = `
        <div class="result-avatar">${avatar}</div>
        <div class="result-info">
            <div class="result-name">${name}</div>
            <div class="result-stats">
                النقاط / Points: ${points} |
                الوقت / Time: ${Math.floor(time / 60)}:${(time % 60).toString().padStart(2,'0')}
            </div>
        </div>
    `;
    return card;
}

function renderResultsList(rows) {
    const container = document.getElementById('resultsGrid');
    container.innerHTML = '';

    // top 3 highlighted
    rows.slice(0,3).forEach((r, i) => {
        const isCurrent = (gameState.currentPlayer && String(gameState.currentPlayer.code) === String(r.Code));
        container.appendChild(createResultCard(r, true, isCurrent));
    });

    // rest
    rows.slice(3).forEach(r => {
        const isCurrent = (gameState.currentPlayer && String(gameState.currentPlayer.code) === String(r.Code));
        container.appendChild(createResultCard(r, false, isCurrent));
    });

    // final note
    const finalNote = document.getElementById('finalNote');
    if (gameState.gameExpired) {
        finalNote.innerHTML = `<div class="timer-expired">انتهت فترة اللعبة! هذه هي النتائج النهائية<br>Game period has ended! These are the final results</div>`;
    } else {
        finalNote.innerHTML = `هذه هي النتائج الحالية (قد تتغير مع انتهاء بقية اللاعبين)<br>These are the current results (they may change as more players finish).`;
    }
}

/* --------------- End script --------------- */
    </script>
    </body>

</html>




